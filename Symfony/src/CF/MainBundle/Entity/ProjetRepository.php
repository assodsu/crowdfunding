<?php

namespace CF\MainBundle\Entity;

/**
 * ProjetAccueilRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProjetRepository extends \Doctrine\ORM\EntityRepository
{
    public function getUnique($projet) {
        $qb = $this->createQueryBuilder('p');
         
        $qb->join('p.boxs', 'b')
           ->where('p.id = :idProjet')
           ->setParameter('idProjet', $projet->getId())
           ;
                 
        return $qb->getQuery()->getSingleResult();
    }

	public function getProjetsAboutissants()
    {  
        $qb = $this->createQueryBuilder('p');
         
        $qb->where('p.valider = true')
           ->orderBy('p.dateFin', 'ASC')
           ->setMaxResults(10);
                 
        return $qb->getQuery()->getResult();
    }

    public function getProjetsNouveaux()
    {  
        $qb = $this->createQueryBuilder('p');
         
        $qb->where('p.valider = true')
           ->orderBy('p.dateCreation', 'DESC')
           ->setMaxResults(10);
                 
        return $qb->getQuery()->getResult();
    }

	public function getSearchList($motcle)
    {  
        $qb = $this->createQueryBuilder('p');
         
        $qb->leftJoin('p.association', 'a')
            ->leftJoin('p.tags', 't')
        	->where('p.valider = 1 AND (p.nom LIKE :motcle OR a.ville LIKE :motcle OR t.nom LIKE :motcle)')
            ->setParameter('motcle', '%'.$motcle.'%');
                 
        return $qb->getQuery()->getResult();
    }

    public function getValidate($index, $nb)
    {
        $qb = $this->createQueryBuilder('p');
         
        $qb->where('p.valider = true')
           ->orderBy('p.dateCreation','DESC')
           ->setFirstResult($index)
           ->setMaxResults($nb)
        ;
                 
        return $qb->getQuery()->getResult();
    }

    public function getValidateSearch($index, $nb, $motcle)
    {
        $qb = $this->createQueryBuilder('p');
         
        $qb->leftJoin('p.association', 'a')
           ->leftJoin('p.tags', 't')
           ->where('p.valider = 1 AND (p.nom LIKE :motcle OR a.ville LIKE :motcle OR t.nom LIKE :motcle)')
           ->setParameter('motcle', '%'.$motcle.'%')
           ->orderBy('p.dateCreation','DESC')
           ->setFirstResult($index)
           ->setMaxResults($nb)
        ;
                 
        return $qb->getQuery()->getResult();
    }

    public function getProjetsProfilEnCours($user)
    {
        $qb = $this->createQueryBuilder('p');
         
        $qb->join('p.association', 'u')
           ->where('u.id = :userId')
           ->setParameter('userId', $user->getId())
           ->andWhere('p.dateFin >= :today')
           ->setParameter('today', new \DateTime())
        ;
                 
        return $qb->getQuery()->getResult();
    }

    public function getProjetsProfilFini($user)
    {
        $qb = $this->createQueryBuilder('p');
         
        $qb->join('p.association', 'u')
           ->where('u.id = :userId')
           ->setParameter('userId', $user->getId())
           ->andWhere('p.dateFin < :today')
           ->setParameter('today', new \DateTime())
        ;
                 
        return $qb->getQuery()->getResult();
    }
}